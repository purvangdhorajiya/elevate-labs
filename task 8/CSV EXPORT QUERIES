SELECT 
    customer_id,
    customer_name,
    region,
    SUM(sales) AS total_sales,
    DENSE_RANK() OVER (PARTITION BY region ORDER BY SUM(sales) DESC) AS rank_in_region
FROM orders
GROUP BY customer_id, customer_name, region
ORDER BY region, rank_in_region;
